{% extends "base.html" %}

{% block title %}
{{ title }}
{% endblock %}

{% block content %}
{% load widget_tweaks %}
<div class="container mt-5 p-3 rounded connect-options" style="background-color: #292826; color: #F9D342;">
    <h1><em>{{ title }}</em></h1>


    <form class="form" method="post">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.title|add_class:"form-control mt-4" }}
        </div>
        <div class="my-3">
            {{ form.text|safe }}
        </div>
        <div class="row">
            <div class="col-9">
                {{ form.salary|add_class:"form-control mt-4" }}
            </div>
            <div class="col-3 mt-4">
                {{ form.currency|add_class:"custom-select" }}
            </div>
        </div>
        <div class="md-3">
            {{ form.experience_months|add_class:"form-control mt-4" }}
        </div>
        <input name="submit_button" value="Submit" type="submit"
            class="btn btn-primary mt-3 mb-3 btn-lg significant-button" />
    </form>


    <h1><em>Skills</em></h1>
    <div id="skill_list">
    </div>

    <form class="form">
        {% csrf_token %}
        <input id="skill_text" required type="text" maxlength="50" placeholder="Skill description" class="form-control mt-4" />
        <div class="row">
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <input type="button" name="add_skill_btn" onclick="pushSkill()" value="Add skill"
                    class="btn btn-primary mx-auto my-5 btn-lg significant-button" />
            </div>
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <input type="button" name="remove_skill_btn" onclick="popSkill()" value="Remove skill"
                    class="btn btn-danger mx-auto my-5 btn-lg significant-button" />
            </div>
        </div>
    </form>

    {% if vacancy %}
    <h1><em>Responsiblities</em></h1>
    <div id="resp_list">
    </div>

    <form class="form">
        {% csrf_token %}
        <input id="resp_text" required type="text" maxlength="50" placeholder="Responsibility text" class="form-control mt-4" />
        <div class="row">
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <input type="button" name="add_resp_btn" onclick="pushResp()" value="Add responsibility"
                    class="btn btn-primary mx-auto my-5 btn-lg significant-button" />
            </div>
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <input type="button" name="remove_resp_btn" onclick="popResp()" value="Remove responsibility"
                    class="btn btn-danger mx-auto my-5 btn-lg significant-button" />
            </div>
        </div>
    </form>
    {% endif %}

    {% if resume %}
    <h1><em>Projects</em></h1>
    <div id="project_list">
    </div>

    <form class="form">
        {% csrf_token %}
        <input id="project_text" required type="text" maxlength="50" placeholder="Project description" class="form-control mt-4" />
        <input id="project_link" type="url" maxlength="50" placeholder="Link to your project" class="form-control mt-4" />
        <div class="row">
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <input type="button" name="add_project_btn" onclick="pushProject()" value="Add project"
                    class="btn btn-primary mx-auto my-5 btn-lg significant-button" />
            </div>
            <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                <input type="button" name="remove_project_btn" onclick="popProject()" value="Remove project"
                    class="btn btn-danger mx-auto my-5 btn-lg significant-button" />
            </div>
        </div>
    </form>
    {% endif %}
</div>

<script>
    var titleField = document.getElementById('id_title')
    var salaryField = document.getElementById('id_salary')
    var experienceField = document.getElementById('id_experience_months')

    window.onload = () => {
        titleField.placeholder = '{% if vacancy %}Your vacancy title{% else %}Your resume title{% endif %}'
        salaryField.placeholder = '{% if vacancy %}Future employee`s salary{% else %}Expected salary{% endif %}'
        experienceField.placeholder = '{% if vacancy %}Expected experience(in months){% else %}Your experience(in months){% endif %}'
    }

    skills = []
    responsibilities = []
    projects = []

    var createPanelElement = (variable) => {
        elem = document.createElement("div")
        elem.className = 'col-12 mx-auto my-2 rounded connect-options text-center'
        elem.style = 'background-color: rgb(173, 173, 173); color: #292826;'
        elem.innerHTML = `<h3>${variable}</h3>`

        return elem
    }

    var pushSkill = () => {
        skill = document.getElementById("skill_text")
        if (!skill.value) return;
        skill_list = document.getElementById("skill_list")
        skills.push(skill.value)
        skill_list.appendChild(createPanelElement(skill.value))
        skill.value = ''
    }

    var popSkill = () => {
        skills.pop()
        skill_list = document.getElementById("skill_list")
        if (skill_list.lastChild) skill_list.lastChild.remove()
    }

    var validURL = (str) => {
        var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
          '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
          '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
          '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
          '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
          '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
        return !!pattern.test(str);
    }

    var pushProject = () => {
        project_text = document.getElementById("project_text")
        if (!project_text.value) return;
        project_link = document.getElementById("project_link")
        if (project_link.value && !validURL(project_link.value)) {
            project_text.value = ''
            project_link.value = ''
            alert("Invalid link. Must start with 'http' or 'https'")
            return;
        }
        projects.push({ 
            'text' : project_text.value, 
            'link' : project_link.value,
        })

        display_project_text = project_text.value
        if (project_link.value !== '')
            display_project_text += '(<a href="' + project_link.value + '">link</a>)'

        project_list.appendChild(createPanelElement(display_project_text))
        project_text.value = project_link.value = ''
    }

    var popProject = () => {
        projects.pop()
        project_list = document.getElementById("project_list")
        if (project_list.lastChild) project_list.lastChild.remove()
    }

    var pushResp = () => {
        resp = document.getElementById("resp_text")
        if (!resp.value) return;
        resp_list = document.getElementById("resp_list")
        responsibilities.push(resp.value)
        resp_list.appendChild(createPanelElement(resp.value))
        resp.value = ''
    }

    var popResp = () => {
        responsibilities.pop()
        resp_list = document.getElementById("resp_list")
        if (resp_list.lastChild) resp_list.lastChild.remove()
    }
</script>
{% endblock %}
